# CLAUDE.md

# デジタル IC カードサービス開発ガイド

このドキュメントは、AI アシスタント Claude が本プロジェクトの開発をサポートするために必要な情報を提供します。
プロジェクトの概要、技術スタック、コーディング規約、ディレクトリ構成、主要コマンド、ワークフロー、および重要な注意事項について記述します。

---

## 1. 全体注意事項

- **回答言語:** すべての回答は**日本語**で行ってください。
- **ドキュメント参照:** 各フェーズの作業を開始する前に、必ず関連するドキュメントを確認してください。
- **安全性:** 本プロジェクトは技術検証・学習目的のプロトタイプであり、実際の金銭取引や個人を特定できる機密情報の取り扱いには十分注意してください。

---

## 2. プロジェクト概要

### 何を作るプロジェクトか

モバイル Suica のようなデジタル IC カードサービスを構築します。スマートフォンアプリとして、残高管理、定期券機能、QR コード切符機能、利用履歴表示を提供します。

### 目的

本プロジェクトは**技術検証・学習目的のプロトタイプ**であり、React Native (Expo) と Supabase を用いたモダンなモバイルアプリ開発スキル習得を主目的とします。

### 主要な機能

- **アカウント管理:** ユーザー登録（メール/パスワード、ソーシャルログイン）、生体認証、アカウント残高表示。
- **決済機能 (モック実装):** 残高チャージ（実際には課金されないデモモード）、交通機関/買い物での残高減少シミュレーション。
- **定期券機能:** 定期券の発行・管理（購入はモック決済）。
- **QR コード切符機能:** QR コード切符の発券・利用（デモ機能）。
- **NFC 機能 (実験的実装):** 簡易リーダーとの NFC 通信によるデータ読み取り。
- **履歴管理:** 利用履歴の表示。

### 開発環境

- **対象 OS:** iOS 13.0 以上、Android 8.0 以上
- **開発環境:** Windows11
- **Node.js:** v18 以上推奨
- **パッケージマネージャー:** npm または yarn

---

## 3. 進捗状況

- 必ず `docs/progress.md` を確認し、プロジェクトの進捗状況を把握してください。

## 4. 要件定義

- 必ず `docs/requirements.md` を確認し、プロジェクトの機能要件、デザイン要件、技術要件、データベース構成を理解してください。

---

## 5. 設計書

- 必ず `docs/design_spec.md` を確認し、システムアーキテクチャ、フロントエンド/バックエンドの具体的な設計、決済システムのモック実装、テスト戦略の詳細を理解してください。

---

## 6. 開発タスク

- 必ず `docs/tasks.md` を確認し、現在の開発フェーズと次に着手すべきタスクを把握してください。

---

## 7. 技術スタック

- **フロントエンド (モバイルアプリ):**
  - 言語: **TypeScript**
  - フレームワーク: **React Native** (Expo を利用)
  - 状態管理: Context API + React Hooks (必要に応じて Redux Toolkit も検討)
  - UI ライブラリ: React Native Paper を主に使用
- **バックエンド / データベース / 認証:**
  - サービス: **Supabase** (PostgreSQL ベース)
  - データベース言語: SQL (PostgreSQL)
  - バックエンドロジック: Supabase Edge Functions (TypeScript/Deno) - モック決済処理などに利用
- **テストフレームワーク:** Jest, React Native Testing Library (E2E テストは Detox/Appium を検討)

---

## 8. コーディング規約

- **言語:** TypeScript を必須とします。`any` 型は極力避けてください。
- **変数名の命名ルール:**
  - 変数・関数名: `camelCase` (例: `userName`, `fetchData`)
  - 定数: `UPPER_SNAKE_CASE` (例: `API_KEY`, `MAX_RETRIES`)
  - コンポーネント名、型名、インターフェース名: `PascalCase` (例: `UserProfileScreen`, `IUser`)
- **インデント:** スペース 2 つ
- **セミコロン:** 行末にはセミコロンを付ける (`;`)
- **好みのライブラリ:**
  - データフェッチ: `axios` または組み込みの `fetch` API (`@supabase/supabase-js` を主に利用)
  - 日付操作: `date-fns` または `moment.js` (小規模ならネイティブ Date オブジェクト)
- **禁止事項:**
  - `console.log` の本番コードへの残存 (デバッグ時のみ使用し、コミット前に削除またはコメントアウト)。
  - `any` 型の多用。具体的な型定義を心がける。
  - 直接的なネイティブモジュールへのアクセス (Managed Workflow の範囲内で可能な限り Expo Modules を使用)。
  - 環境変数や API キーなどの機密情報をコード内に直接記述する。
  - ハードコードされたマジックナンバー（定数化を推奨）。
  - 長すぎる関数（目安: 50 行以内）。関心事の分離を意識する。
  - 深すぎるネスト（目安: 3 階層まで）。早期リターンやガード節を活用する。

---

## 9. 開発コマンド

- **依存関係のインストール:**

  ```bash
  npm install
  ```

- **Expo 開発サーバーを起動:**

  ```bash
  npm start
  ```

- **特定のプラットフォームで起動:**

  ```bash
  npm run android # Android エミュレーター
  npm run ios # iOS シミュレーター (macOS のみ)
  npm run web # Web ブラウザ
  ```

- **テストの実行 (Jest):**

  ```bash
  npm test
  ```

- **ローカル Supabase 管理**

  ```bash
  npm run supabase:start # ローカル Supabase を起動 (Docker Desktop が必要)
  npm run supabase:stop # ローカル Supabase を停止
  npm run supabase:status # Supabase のステータスを確認

  ```

---

## 10. ワークフロー

- **Git のコミットメッセージ規約:**
  - [Conventional Commits](https://www.conventionalcommits.org/en/v1.0.0/) に準拠します。
  - 例:
    - `feat: ログイン機能を追加`
    - `fix: 残高表示のバグを修正`
    - `docs: READMEを更新`
    - `refactor: 認証ロジックをリファクタリング`
    - `chore: 依存関係を更新`

- **ブランチ戦略:**
  - `main` ブランチ: 安定版
  - `develop` ブランチ: 開発の主要ブランチ
  - `feature/XXX` ブランチ: 各機能開発用のブランチ (例: `feature/user-auth`, `feature/charge-mock`)
  - `fix/XXX` ブランチ: バグ修正用のブランチ

- **プルリクの作成手順:**
  1.  `develop` ブランチから機能ブランチ (`feature/XXX`) を作成。
  2.  開発・テストを行いコミット。
  3.  develop へ PR 作成。変更内容、目的、テスト方法を記述。
  4.  チームメンバー（またはセルフレビュー）によるコードレビューを実施。
  5.  承認後、`develop` ブランチにマージ。

- **注意点:**
  - 作業を始める前に、必ず現在のブランチを確認してください。
  - ブランチを切る際、ブランチの命名に気を付けること。
  - フェーズごとではなく、各機能や各画面ごとにブランチを切ること。
    └ NG: feature/phase3-ui-ux
    └ OK: feature/auth, feature/tagなど
    ※「phase」を含まない
  - `main` ブランチへの直接プッシュは禁止。

---

## 11. ファイル作成時の注意点

- ファイル作成時に、そのファイルが GitHub に挙げるべきではないと判断した場合には、必ず `.gitignore` に指定してください。

---

## 12. 修正の際の注意点

- **影響範囲の確認:**
  - 修正対象のファイルが他のファイルからインポートされていないか確認
  - 型定義の変更は、その型を使用している全ての箇所をチェック

- **テストの実行:**
  - 修正後は必ず関連するテストを実行
  - 新しい機能追加時は、対応するテストも追加

- **段階的な修正:**
  - 大規模な変更は小さな単位に分割して実施
  - 各段階で動作確認を行う

- **後方互換性:**
  - 既存のデータ構造を変更する場合は、マイグレーション戦略を検討
  - API の変更は、既存の呼び出し側への影響を考慮

---

## 13. Claude Code 使用時の注意事項

- **自律的な作業:** Claude Code は複数のファイルを横断して自律的に作業を進めます。変更内容は必ず確認してください。
- **ファイル編集の承認:** 重要なファイル（設定ファイル、認証関連など）の編集時は、変更内容を十分に確認してから承認してください。
- **エラーハンドリング:** Claude Code が提案する修正でエラーが発生した場合、エラーメッセージを共有して再試行してください。
- **並行作業の制限:** Claude Code での作業中は、手動でのファイル編集を避けてください（競合を防ぐため）。

---

## 14. 環境変数の管理

- 環境変数は `.env.local` ファイルで管理します。
- Supabase の接続情報など、機密情報は `.gitignore` で除外されていることを確認してください。
- Expo の環境変数は `app.config.ts` または `eas.json` で管理します。
- 必須の環境変数:
  - `SUPABASE_URL`: Supabase プロジェクトの url
  - `SUPABASE_ANON_KEY`: Supabase の匿名キー
  - `EXPO_PUBLIC_API_URL`: API のベース URL（必要に応じて）

---

## 15. ディレクトリ構成

本プロジェクトは`src`フォルダーを使用し、ソースコードを整理します。
Expo Router は`src/app`フォルダーをルーティングの中心とします。

```

/
├── src/
│   ├── app/                         # 画面・ルーティング（Expo Router）
│   ├── components/                  # 再利用可能なUIコンポーネント
│   ├── hooks/                       # カスタムフック
│   ├── services/                    # API通信、Supabase連携
│   ├── contexts/                    # Context API関連
│   ├── types/                       # TypeScript型定義
│   ├── utils/                       # ユーティリティ関数
│   └── constants/                   # 定数定義
├── assets/                           # 画像、フォントなど
├── docs/                             # ドキュメント
├── __tests__/                        # テストファイル
```

**注意事項:**

- `src/app`フォルダー内のファイル構成は、そのまま URL ルーティングに反映されます
- 画面以外のロジックは`src/app`フォルダー外に配置します

---

## 16. デバッグとトラブルシューティング

- **Expo Go での動作確認:** 開発中は Expo Go アプリでの動作確認を基本とします。
- **ログの確認:** `npx expo start` 実行中のターミナル、または Expo Dev Tools でログを確認できます。
- **React Native Debugger:** より詳細なデバッグには React Native Debugger の使用を推奨します。
- **よくあるエラー:**
  - モジュール解決エラー → キャッシュクリア (`npx expo start -c`)
  - 型エラー → `npx tsc --noEmit` で事前チェック
  - Supabase 接続エラー → 環境変数の確認

---

## 17. コードレビューワークフロー（Claude Code + CodeRabbit）

本プロジェクトでは、**Claude Code による「高速実装」と CodeRabbit による「厳格な品質管理」**を組み合わせた AI 駆動開発（AIDD）フローを採用します。

### 役割分担

- **Claude Code**: 実装、テストコード作成、PR 作成、CLI ツールの実行。
- **CodeRabbit (GitHub 連携)**: PR 作成後の最終自動レビュー、学習済みコンテキストに基づく指摘。
- **開発者**: AI 間の整合性確認、マージ可否の最終判断。

### 開発フロー

#### 1. **実装依頼**:

開発者が Claude Code にタスクを依頼します。

#### 2. **実装**:

Claude Code がコードを作成します。

#### 3. **PR作成 & PRレビュー**:

Claude CodeがPRを作成し、GitHub上のCodeRabbitによるレビューを受けます。

### Claude Codeへの指示テンプレート

**【ステップ1：GitHub上の指摘への対応】**
CodeRabbitからPRに以下の指摘が届きました。
URL: [PRのリンク]
指摘内容: 「[指摘箇所のコピペ]」

この指摘を反映して、既存のブランチにpushしてください。

### 連携を最大化する設定

- **CLAUDE.mdの共有**:
  CodeRabbitの設定で CLAUDE.md を学習対象に含め、Claude Codeが書いたコードを本プロジェクトの規約に照らしてレビューさせます。

- **AI間の対話**:
  開発者は、CodeRabbitの「なぜその修正が必要か」という論理的な指摘を、そのままClaude Codeの「どう修正するか」という実装力に変換する仲介役として振る舞います。

---

## 18. セッション管理（長期プロジェクト対応）

本プロジェクトは数日〜数週間かかるため、作業の継続性を保つための仕組みを導入しています。

### progress.mdの管理

`docs/progress.md`ファイルで、プロジェクトの進捗状況を常に最新に保ちます。

### セッション再開の流れ

1. **progress.mdを確認**
   - 前回どこまで進んだか
   - 何が未完了か
   - 次に何をすべきか

2. **git statusを確認**
   - 未コミットの変更がないか
   - 正しいブランチにいるか

3. **前回の課題を確認**
   - CodeRabbitの未対応指摘
   - 未解決のバグやエラー

4. **作業再開**
   - progress.mdの「次回やること」から開始

5. **定期的な記録**
   - 大きな節目でprogress.mdを更新
   - 1日の終わりには必ず更新

### progress.md更新のタイミング

- ✅ フェーズが完了したとき
- ✅ 重要な技術的決定をしたとき
- ✅ 問題が発生し解決したとき
- ✅ セッション終了時（必須）
- ✅ 設計変更があったとき

### 注意事項

- progress.mdは必ずcommitしてpushする（ローカルだけだと失われる可能性）
- 曖昧な記録ではなく、具体的に記録する
- 「なぜその決定をしたか」も記録する
- Claude Codeが次回スムーズに再開できる情報を残す
