---
### デジタルICカードサービス 設計書 (再改訂版)

この設計書は、デジタルICカードサービスの各コンポーネントの構造、機能、および相互作用を詳細に記述するものです。
---

### 1. システムアーキテクチャ概要

- **クライアント:** React Native (Expo 利用) で構築される iOS/Android ネイティブアプリケーション。
- **バックエンド:** Supabase (PostgreSQL ベース) を中心としたサーバーレスアーキテクチャ。認証、データベース、API エンドポイントを提供。
- **注意点:** 本プロジェクトは技術検証・学習目的のプロトタイプであり、実際の金銭取引や公共交通機関との連携は行いません。決済機能はモック（ダミー）実装とし、NFC 機能は実験的な実装に留めます。**アプリの公開・デプロイは行いません。**

### 2. フロントエンド設計 (React Native with Expo)

- **開発環境:** Expo CLI を使用した Managed Workflow。開発中のアプリは Expo Go アプリやローカルビルドで実機テストを行う。
- **主要画面構成:**
  - **ログイン/登録画面:** メールアドレス/パスワード、Google/Apple ID での認証フロー。
  - **メイン画面:**
    - 残高表示コンポーネント。
    - 定期券情報表示コンポーネント（中央揃え）。
    - 条件付き QR コード切符表示コンポーネント（発券時のみ表示）。
    - フッターナビゲーション（Home, History, Charge, Settings）。
  - **利用履歴画面:** トランザクション一覧表示、フィルタリング機能。
  - **チャージ画面:** **(モック実装)** チャージ金額入力。実際には課金されないデモモード。UI は表示するが、実際の決済ゲートウェイ連携は行わない。
  - **定期券購入/管理画面:** 定期券区間・期間選択、購入フロー（モック決済）、既存定期券の詳細表示。
  - **QR コード切符発行画面:** 区間選択、発行フロー。
  - **設定画面:** ユーザー情報編集、通知設定など。
- **状態管理:** Context API と React Hooks を基本とし、大規模な状態管理が必要な場合は Redux Toolkit などを検討。
- **API 通信:** Supabase クライアントライブラリ (`@supabase/supabase-js`) を使用して、Supabase の RESTful API とリアルタイム機能を利用。
- **UI ライブラリ:** React Native Paper, NativeBase, UI Kitten などのコンポーネントライブラリを検討し、一貫したデザインを実装。
- **生体認証:** `expo-local-authentication` などの Expo モジュールを利用して、Touch ID / Face ID を実装。
- **NFC 機能:** `react-native-nfc-manager` などのライブラリを Expo Custom Dev Client / Bare Workflow で利用し、簡易的な IC カードリーダーとの連携を実験的に実装。

### 3. バックエンド設計 (Supabase)

- **データベース:** PostgreSQL (Supabase 提供)
  - **テーブルスキーマ:** (「データベース構成(./database.md)」で詳述した各テーブルとそのカラム、データ型、制約をここで詳細に定義)
    - 例: `users` (id UUID PRIMARY KEY, email TEXT UNIQUE NOT NULL, password_hash TEXT, created_at TIMESTAMPTZ DEFAULT NOW())
  - **リレーションシップ:** (「データベースのリレーションシップ(./database.md)」で詳述したリレーションを FOREIGN KEY として設定)
- **認証:** Supabase Authentication
  - メールアドレスとパスワードによるサインアップ/ログイン。
  - Google、Apple ID による OAuth ログイン。
  - パスワードリセット機能。
  - JWT (JSON Web Token) を利用したセッション管理。
- **API:** Supabase PostgREST
  - データベースのテーブルに対して自動的に RESTful API エンドポイントが生成される。
  - RDB の CRUD 操作を HTTP リクエストで実行。
- **リアルタイム機能:** Supabase Realtime
  - 特定のデータ変更を購読し、クライアントアプリにリアルタイムで通知する機能（例: 残高の即時更新）。
- **セキュリティ (Row Level Security - RLS):**
  - Supabase の RLS ポリシーを設定し、各ユーザーが自分のデータのみにアクセスできるよう厳密に制御。
- **サーバーサイドロジック (Edge Functions):**
  - **決済ロジックはモックとして実装。** 実際の外部決済ゲートウェイ連携は行わない。
  - その他のビジネスロジックのために、Deno ベースの Edge Functions (TypeScript) を利用。

### 4. 決済システム設計 **(モック実装)**

- **決済ゲートウェイ連携:**
  - **実際の決済ゲートウェイ（GMO-PG/SBPS など）との連携は行わない。**
  - デモモードとして、**固定の「仮想クレジットカード」またはアプリ内通貨として完全にクローズドな実装**を想定。
- **チャージ処理フロー (モック):**
  1.  ユーザーがアプリでチャージ金額を入力。
  2.  内部的に**課金は行わず**、ユーザーの`accounts`テーブルの`balance`を更新（増加）。
  3.  `transactions`テーブルにチャージ履歴を記録（種別を「デモチャージ」などと区別）。
  4.  結果をアプリに返し、残高をリアルタイムで更新。
- **定期券購入フロー (モック):**
  1.  ユーザーが定期券の区間、期間を選択。
  2.  内部的に**課金は行わず**、ユーザーの`accounts`テーブルの`balance`を更新（減少）。
  3.  `commuter_passes`テーブルに定期券情報を記録。
  4.  `transactions`テーブルに定期券購入履歴を記録（種別を「デモ購入」などと区別）。
  5.  結果をアプリに返し、残高をリアルタイムで更新。

### 6. デプロイメントと CI/CD 設計 **(省略)**

- **デプロイを行わない**ため、関連する CI/CD パイプライン構築、App Store/Google Play Store への申請、Vercel へのデプロイなどの項目は**今回のスコープでは省略する。**
- 開発中のテストは、Expo Go アプリやローカルビルド (`eas build --platform ios/android`) で生成したバイナリを直接デバイスにインストールして行う。

### 7. テストと監視設計

- **テスト:**
  - **ユニットテスト:** Jest を使用し、個々のコンポーネントやビジネスロジックの関数をテスト。
  - **コンポーネントテスト:** React Native Testing Library を使用し、UI コンポーネントの挙動をユーザー視点でテスト。
  - **E2E テスト:** Detox または Appium を検討し、実機に近い環境でのエンドツーエンドの動作確認。

---
